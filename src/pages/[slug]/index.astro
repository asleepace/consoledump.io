---
import { ConsoleDumpClient } from '@/components/react/ConsoleDumpClient'
import Layout from '@/layouts/Layout.astro'
import { sessions } from '@/lib/server/'
import { urlStore } from '@/lib/shared/url-store'

urlStore.setUrl(Astro.url)

// NOTE: do not server-side render!
export const prerender = false

const { slug: streamId } = Astro.params
const { method } = Astro.request

// handle CORS requests
if (method === 'OPTIONS') {
  return new Response(null, {
    headers: {
      'access-control-allow-origin': '*',
      'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
    },
  })
}

if (!streamId) {
  return Response.json({ error: 'Missing streamId.' }, { status: 500 })
}

// get or create a stream session
const stream = await sessions.getOrCreate(streamId)

// handle posting data to stream
if (method === 'POST') {
  if (!Astro.request.body)
    return Response.json({ error: 'Missing POST body!' }, { status: 500 })
  stream.publish(Astro.request.body)
  return Response.json({ ok: true })
}
---

<Layout>
  <ConsoleDumpClient initialUrl={Astro.url} client:load />
</Layout>
