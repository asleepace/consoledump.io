---
import { ConsoleDumpClient } from '@/components/react/ConsoleDumpClient'
import Layout from '@/layouts/Layout.astro'
import { Stream2 } from '@/lib/server/stream'

export const prerender = false

const HEADERS_WITH_CORS: HeadersInit = {
  'access-control-allow-origin': '*',
  'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
}

const { slug: streamId } = Astro.params

const stream = Stream2.get(streamId) ?? Stream2.use(streamId)

if (Astro.request.method === 'POST') {
  if (!stream) {
    return new Response(null, {
      status: 404,
      statusText: 'Stream not found',
      headers: HEADERS_WITH_CORS,
    })
  }

  if (stream.isClosed) {
    return new Response(null, {
      status: 500,
      statusText: 'Stream is closed',
      headers: HEADERS_WITH_CORS,
    })
  }

  if (!Astro.request.body) {
    return new Response(null, {
      status: 500,
      statusText: 'Invalid body sent',
      headers: HEADERS_WITH_CORS,
    })
  }

  try {
    await stream?.push(Astro.request.body)

    return new Response(null, {
      status: 200,
      headers: HEADERS_WITH_CORS,
    })
  } catch (e) {
    console.warn('[slug] error:', e)
    return new Response(null, {
      status: 500,
      headers: HEADERS_WITH_CORS,
    })
  }
}
---

<Layout>
  <ConsoleDumpClient />
</Layout>
