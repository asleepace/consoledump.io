---
import { ConsoleDumpClient } from '@/components/ConsoleDumpClient'
import Layout from '@/layouts/Layout.astro'
import { sessions } from '@/lib/server/'
import { siteConfig } from '@/consts'

// NOTE: do not server-side render!
export const prerender = false
const { slug: streamId } = Astro.params
const { method } = Astro.request

// handle CORS requests
if (method === 'OPTIONS') {
  return new Response(null, {
    headers: {
      'access-control-allow-origin': '*',
      'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
    },
  })
}

if (!streamId) {
  return Response.json({ error: 'Missing streamId.' }, { status: 500 })
}

// get or create a stream session
const stream = await sessions.getOrCreate(streamId)

// handle posting data to stream
if (method === 'POST') {
  if (!Astro.request.body) {
    return Response.json({ error: 'Missing POST body!' }, { status: 500 })
  }
  stream.publish(Astro.request.body)
  return Response.json({ ok: true })
}

// construct url to pass as initial props
const url = new URL(streamId, siteConfig.url)

// flag if we should show welcome message
const showTutorial = stream.info.fileSize === 0
---

<Layout>
  <ConsoleDumpClient initialUrl={url} showTutorial={showTutorial} client:load />
</Layout>
